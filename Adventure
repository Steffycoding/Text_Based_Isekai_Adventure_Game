import time
import pickle
import os

def introduction():
    print("Welcome to the Epic Isekai Adventure Game!")
    time.sleep(1)
    print("You and your high school friends find yourselves in a magical forest.")
    time.sleep(1)
    print("Your goal is to navigate through this mysterious world and uncover its secrets.")
    time.sleep(1)
    print("Let the epic isekai adventure begin!\n")

def save_game(player_data):
    with open("saved_game.pkl", "wb") as file:
        pickle.dump(player_data, file)

def load_game():
    if os.path.exists("saved_game.pkl"):
        with open("saved_game.pkl", "rb") as file:
            return pickle.load(file)
    else:
        return None

def make_choice(choices):
    print("Choose your next move:")
    for index, choice in enumerate(choices, start=1):
        print(f"{index}. {choice}")

    while True:
        try:
            choice = int(input("Enter the number of your choice: "))
            if 1 <= choice <= len(choices):
                return choice
            else:
                print("Invalid choice. Try again.")
        except ValueError:
            print("Invalid input. Please enter a number.")

def explore_forest(player_data):
    print("\nYou and your high school friends find yourselves in a magical forest...")
    time.sleep(1)
    print("As you wander deeper, you encounter a crossroads with diverging paths.")

    choices = ["Follow the sunlight path", "Enter the mysterious grove"]
    choice = make_choice(choices)

    if choice == 1:
        print("\nYou chose to follow the path illuminated by sunlight.")
        time.sleep(1)
        print("The air becomes warmer, and you discover a hidden clearing.")
        magical_clearing(player_data)
    else:
        print("\nYou chose to enter the mysterious grove.")
        time.sleep(1)
        print("The trees whisper ancient secrets, and you sense a magical presence.")
        magical_grove(player_data)

def magical_clearing(player_data):
    print("\nYou and your friends enter a magical clearing filled with glowing flowers!")
    time.sleep(1)
    print("Congratulations! You've found a place of tranquility and enchantment.")
    time.sleep(1)
    print("As you appreciate the beauty, a portal appears before you.")
    time.sleep(1)
    print("You decide to step through, wondering where it might lead.")
    time.sleep(1)

    if player_data["completed_game"]:
        print("You feel a mysterious energy surrounding you.")
        time.sleep(1)
        print("A voice whispers, 'Your journey continues beyond the known realms.'")
        time.sleep(1)
        print("The portal transports you to an unknown destination.")
        time.sleep(1)
        print("Where does this mysterious journey truly end?")
        end_of_story(player_data)
    else:
        print("Where does this epic isekai journey end?")
        end_of_story(player_data)

def magical_grove(player_data):
    print("\nYou and your friends walk deeper into the mysterious grove.")
    time.sleep(1)
    print("The air shimmers with magical energy, and you discover a hidden fountain.")
    time.sleep(1)
    print("As you approach, the water sparkles with otherworldly colors.")
    time.sleep(1)
    print("You take a moment to drink from the magical fountain and feel a surge of energy.")
    time.sleep(1)
    print("A pathway reveals itself, leading you to an ethereal garden.")
    time.sleep(1)
    print("Where does this epic isekai journey end?")
    end_of_story(player_data)

def end_of_story(player_data):
    print("\nYou and your friends follow the magical path and find yourselves at the edge of the ethereal garden.")
    time.sleep(1)
    print("Before you lies a portal shimmering with an otherworldly light.")
    time.sleep(1)
    print("As you step through, the world transforms around you.")
    time.sleep(1)
    print("A voice echoes, 'Your epic isekai adventure has just begun. What new challenges await in this magical realm?'")
    time.sleep(1)

    if player_data["completed_game"]:
        print("The portal closes behind you, leaving you with the mystery of what lies ahead.")
        time.sleep(1)
        print("Where does this enchanting isekai journey truly end?")
        print("Thank you for playing the Epic Isekai Adventure Game!")
    else:
        print("The portal transports you back to your world.")
        time.sleep(1)
        print("You and your friends share a knowing smile, grateful for the adventures you've experienced together.")
        time.sleep(1)
        print("The mystery of the isekai world lingers in your memories.")
        time.sleep(1)
        print("Thank you for playing!")

def main():
    player_name = input("Enter your name: ")
    player_password = input("Choose a password: ")

    player_data = load_game()

    if player_data and player_data["name"] == player_name and player_data["password"] == player_password:
        print(f"Welcome back, {player_name}!")

        if player_data["completed_game"]:
            print("Congratulations! You've already completed the epic isekai adventure.")
            if input("Do you want to replay the adventure? (y/n): ").lower() == 'y':
                print("Starting a new epic isekai adventure...")
                player_data["completed_game"] = False
                introduction()
                explore_forest(player_data)
            else:
                print("Thank you for playing!")
        else:
            if input("Do you want to continue your saved epic isekai adventure? (y/n): ").lower() == 'y':
                print("Loading saved game...")
                explore_forest(player_data)
            else:
                print("Starting a new epic isekai adventure...")
                introduction()
                explore_forest(player_data)

    else:
        print(f"Welcome, {player_name}!")
        player_data = {"name": player_name, "password": player_password, "completed_game": False}
        introduction()
        explore_forest(player_data)

    save_game(player_data)

if __name__ == "__main__":
    main()
